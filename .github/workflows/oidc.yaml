name: OIDC Token Request

on:
  workflow_dispatch:
    inputs:
      service_url:
        description: 'The external service URL'
        required: true
        default: 'https://example.com/api'

jobs:
  call-api:
    runs-on: ubuntu-latest
    
    permissions:
      # Necessary for requesting the ID token
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Get GitHub OIDC ID Token and Call API
      run: |
        # Request the OIDC token from GitHub
        TOKEN=$(curl -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                     "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=my-cluster" \
                     | jq -r .value)

        # Use the OIDC token to call an external URL
        curl -k -X GET ${{ github.event.inputs.service_url }} \
        -H "Authorization: Bearer $TOKEN"